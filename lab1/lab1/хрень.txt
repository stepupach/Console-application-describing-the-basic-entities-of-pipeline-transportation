#include <iostream>
#include <fstream>
#include <string>
#include <vector>
using namespace std;

struct pipes {
    int id_pipe = 0;
    double length, diameter; 
    bool condition;
};

struct stations {
    string name;
    int id_cs = 0, all_workshops, active_workshops;
    double performance;
};

template <typename type>
type check_number (type min, type max) {
    type i;
        while ((cin>>i).fail() || i < min || i >  max || cin.get() != '\n') {
            cin.clear();
            cin.ignore(10000, '\n');
            cout << "Try again. Enter number ("<< min <<"-"<< max <<"): ";
        } 
   return i;
}

istream& operator >> (istream& in, pipes& pipe)
{
    system("cls");
    cout << "Create a new pipe! Fill in the gaps\n Length (500-20000 m): ";
    pipe.length = check_number(500.0, 20000.0);
    cout << " Diameter (100-5000 m): ";
    pipe.diameter = check_number(100.0, 5000.0);
    cout << " Condition 0 - Under repair\n           1 - OK\n->";
    pipe.condition = check_number(0, 1);
    return in;
}

istream& operator >> (istream& in, stations& cs)
{
    system("cls");
    cout << " Create a new station! Fill in the gaps\n Name station: ";
    getline(in, cs.name);
    cout << " Number of workshops (1-100): ";
    cs.all_workshops = check_number(1, 100);
    cout << " Number of active workshops (<=all workshops): ";
    cs.active_workshops = check_number(0, cs.all_workshops);
    cs.performance = (double)cs.active_workshops / (double)cs.all_workshops * 100;
    cout << " Performance %: " << cs.performance << endl;
    return in;
}

ostream& operator << (ostream& out, const pipes& pipe)
{
    cout << "\n***Pipe***------+----------------+-----------------------------------------+\n";
    cout << "id:" << pipe.id_pipe;
    cout << "\n|    Length     |    Diameter    | Condition: 0 - Under repair,   1 - OK   |\n";
    printf("|    %.2f     |     %.2f     |              %d                          |\n", pipe.length, pipe.diameter, pipe.condition);
    return out;
}

ostream& operator << (ostream& out, const stations& cs)
{
    cout << "\n***Station***----+---------------------+------------------+\n-->";
    cout << "id:" << cs.id_cs << endl;
    cout << "name:" << cs.name;
    cout << "\n|    All workshops    | Active workshops  | Performance % |\n";
    printf("|         %d         |       %d         |     %.2f    |\n", cs.all_workshops, cs.active_workshops, cs.performance);
    return out;
}

pipes& select_pipe(vector<pipes>& pipe)
{
    cout << "Enter pipe id: ";
    unsigned int id = check_number<uint64_t>(1, pipe.size());
    return pipe[id - 1];
}

stations& select_cs(vector<stations>& cs)
{
    cout << "Enter compressor station id: ";
    unsigned int id = check_number<uint64_t>(1, cs.size());
    return cs[id - 1];
}

void print_pipe (pipes& pipe)
{
    cout << "\n***Pipe***------+----------------+-----------------------------------------+\n";
    cout << "|    Length     |    Diameter    | Condition: 0 - Under repair,   1 - OK   |\n";
    printf("|    %.2f     |     %.2f     |              %d                          |\n", pipe.length, pipe.diameter, pipe.condition);
}

void print_station(stations& cs)
{
    cout << "\n***Station***----+---------------------+------------------+\n-->";
    cout << cs.name;
    cout << "\n|    All workshops    | Active workshops  | Performance % |\n";
    printf("|         %d         |       %d         |     %.2f    |\n", cs.all_workshops, cs.active_workshops, cs.performance);
}

void view (pipes  &pipe, stations& cs) {
    if (pipe.id_pipe > 0 && cs.id_cs == 0)
    {
        print_pipe(pipe);
    }
    else
        if (pipe.id_pipe == 0 && cs.id_cs > 0)
        {
            print_station(cs);
        }
        else
            if (pipe.id_pipe > 0 && cs.id_cs > 0)
            {
                print_pipe(pipe);
                print_station(cs);
            }
            else cout << "You should input objects!" << endl;
}
     
void edit_pipe(pipes &pipe) {
    cout << "\n Pipe condition: " << pipe.condition << ".\n Cnahge it (1- yes; 0 - no)?\n ";
    if (check_number(0, 1) == 1) pipe.condition = (!pipe.condition);
}

void edit_station(stations& cs) {
    cout << "Station has " << cs.active_workshops << " active workshops. New amount active workshops:\n";
    cs.active_workshops = check_number(0, cs.all_workshops);
    cs.performance = (double)cs.active_workshops / (double)cs.all_workshops * 100;
}

/*void save(pipes& pipe, stations& cs) {
    ofstream fout;
    fout.open("data.txt", ios::out);
    if (fout.is_open())
    {
        fout << cs.name << endl << cs.all_workshops<< endl<< cs.active_workshops << endl <<  cs.performance << endl
             << pipe.length << endl << pipe.diameter << endl << pipe.condition << endl;
        fout.close();
    }
    else cout << "Error opening file!\n";
}*/

void save_pipe(ofstream& fout, const pipes& pipe)
{
    string object;
    object = "pipe";
    fout << object << endl;
    fout << pipe.id_pipe << endl << pipe.length << endl << pipe.diameter << endl << pipe.condition << endl;
}

void save_station(ofstream& fout, const stations& cs)
{
    string object;
    object = "compressor station";
    fout << object << endl;
    fout << cs.id_cs << endl << cs.name << endl << cs.all_workshops << endl << cs.active_workshops << endl << cs.performance << endl;
}

void download(pipes& pipe, stations& cs) {
    ifstream fin;
    fin.open("data.txt", ios::in);
    if (fin.is_open())
    {
        getline(fin, cs.name);
        fin >> cs.all_workshops >> cs.active_workshops >> cs.performance >>
            pipe.length >> pipe.diameter >> pipe.condition;;
        view(pipe, cs);
        fin.close();
    }
    else cout << "Error opening file!\n";
}

pipes load_pipe(ifstream& fin)
{
    pipes pipe;
    fin >> pipe.id_pipe;
    fin >> pipe.length;
    fin >> pipe.diameter;
    fin >> pipe.condition;
    return pipe;
}

stations load_station(ifstream& fin)
{
    stations cs;
    fin >> cs.id_cs;
    fin.ignore(10000, '\n');
    getline(fin, cs.name);
    fin >> cs.all_workshops;
    fin >> cs.active_workshops;
    fin >> cs.performance;
    return cs;
}

void print_menu() {
    system("cls"); 
    cout << "   Welcome! This is the menu. Select an action:\n";
    cout << "1. Add pipe\n2. Add compressor station\n3. View all objects\n4. Edit pipe\n5. Edit compressor station\n6. Save\n7. Download\n0. Exit\n->";
}

int main()
{
    //pipes pipe;
   // stations cs;
    vector <pipes> pipeline;
    vector <stations> cs_sistem;
    while (1) {
        print_menu();
            switch (check_number(0, 7)) {
            case 1:
            {
                pipes pipe;
                pipe.id_pipe++;
                cin >> pipe;
                pipeline.push_back(pipe);
                break;
            }
            case 2:
            {
                stations cs;
                cs.id_cs++;
                cin >> cs;
                cs_sistem.push_back(cs);
                break;
            }
            case 3:
            {
                //view(pipe, cs);
                cin.clear();
                system("cls");
                if ((pipeline.size() != 0) && (cs_sistem.size() == 0))
                {
                    for (auto& pipe : pipeline)
                        cout << pipe << endl;
                }
                else if ((pipeline.size() == 0) && (cs_sistem.size() != 0))
                {
                    for (auto& cs : cs_sistem)
                        cout << cs << endl;
                }
                else if ((pipeline.size() != 0) && (cs_sistem.size() != 0))
                {
                    for (auto& p : pipeline)
                        cout << p << endl;
                    for (auto& cs : cs_sistem)
                        cout << cs << endl;
                }
                else cout << "Input objects" << endl;
                break;
            }
            case 4:
            {
               // edit_pipe(pipe);
                cin.clear();
                    if (pipeline.size() > 0)
                    {
                        edit_pipe(select_pipe(pipeline));
                    }
                    else cout << "Input pipe! " << endl;
                break;
            }
            case 5:
            {
               // edit_station(cs);
                cin.clear();
                    if (cs_sistem.size() > 0)
                    {
                        edit_station(select_cs(cs_sistem));
                    }
                    else cout << "Input compressor station! " << endl;
                break;
            }
            case 6:
            {
                //save(pipe, cs);
                ofstream fout;
                fout.open("data.txt", ios::out);
                if (fout.is_open())
                {
                    for (pipes& pipe : pipeline)
                        save_pipe(fout, pipe);
                    for (stations& cs : cs_sistem)
                        save_station(fout, cs);
                    break;
                }
                else cout << "Error opening file!\n";
                break;
            }
            case 7:
            {
               // download(pipe, cs);
                cin.clear();
                system("cls");
                string object;
                ifstream fin;
                fin.open("data.txt", ios::in);
                if (fin.is_open())
                {
                    while (!fin.eof())
                    {
                        getline(fin, object);
                        if (object == "pipe")
                            pipeline.push_back(load_pipe(fin));
                        if (object == "compressor station")
                            cs_sistem.push_back(load_station(fin));
                    }
                    break;
                }
                else
                    cout << "File didn't open!" << endl;
                break;
            }
            case 0:
            {
                cout << "\nGood luck!\n";
                return 0;
            }
            }
               system("pause");
    }
    return 0;
}